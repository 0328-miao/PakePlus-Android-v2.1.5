<!DOCTYPE html>
<html lang="zh-CN">
<head>
<!-- PWA æ”¯æŒ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3a7bd5">

<!-- å°ç»„ä»¶æ”¯æŒ -->
<script src="widget-data.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å¸ˆè¯¾ç¨‹è¡¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding: 12px 8px;
            font-size: 14px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            padding: 12px;
            min-height: calc(100vh - 24px);
        }
        
        .header {
            background: linear-gradient(to right, #3a7bd5, #00d2ff);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .date-info {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .week-type-display {
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .calendar-btn {
            background: none;
            border: none;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            padding: 3px;
            border-radius: 5px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }
        
        .calendar-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .week-nav-btn {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            min-width: 75px;
        }
        
        .week-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .week-nav-btn.current-week {
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        
        .week-nav-btn.back-to-current {
            background-color: #ff9800;
        }
        
        .notes-search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            align-items: flex-start;
            position: relative;
        }
        
        .notes-section {
            flex: 1;
            min-width: 0;
        }
        
        .notes-label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c5282;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .notes-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.85rem;
            resize: vertical;
            min-height: 56px;
            background-color: #f8f9fa;
        }
        
        .search-section {
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-toggle {
            background: #4a6fa5;
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-bottom: 4px;
        }
        
        .search-toggle:hover {
            background: #3a5f95;
        }
        
        .search-box {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            overflow: hidden;
            transition: width 0.3s;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .search-box.active {
            width: 150px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 36px 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.85rem;
            box-sizing: border-box;
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            pointer-events: none;
        }
        
        .search-results {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .search-result-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            border-bottom: 1px dashed #ddd;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .search-result-item:hover {
            background-color: #ffeaa7;
        }
        
        .timetable {
            display: grid;
            grid-template-columns: 50px repeat(5, 1fr);
            gap: 1px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            margin-bottom: 12px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .corner-cell {
            background-color: #4a6fa5;
            color: white;
            text-align: center;
            padding: 4px 2px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 36px;
        }
        
        .time-slot {
            background-color: #f8f9fa;
            padding: 4px 2px;
            text-align: center;
            font-size: 0.65rem;
            color: #555;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 1px solid #e0e0e0;
            min-height: 36px;
        }
        
        .time-label {
            font-weight: bold;
            color: #2c5282;
        }
        
        .time-edit {
            color: #888;
            font-size: 0.6rem;
            margin-top: 1px;
        }
        
        .course-cell {
            background-color: white;
            padding: 4px 2px;
            min-height: 36px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            user-select: none;
        }
        
        .course-cell:hover {
            background-color: #f0f7ff;
        }
        
        .course-content {
            font-size: 0.7rem;
            line-height: 1.1;
            text-align: center;
            width: 100%;
        }
        
        .course-subject {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .course-details {
            color: #666;
            font-size: 0.65rem;
            margin-top: 1px;
        }
        
        .odd-week {
            border-left: 3px solid #00bcd4;
        }
        
        .even-week {
            border-left: 3px solid #4caf50;
        }
        
        /* å­—ä½“é¢œè‰²æ ·å¼ */
        .text-black { color: #000; }
        .text-red { color: #f44336; }
        .text-green { color: #4caf50; }
        
        .week-indicator {
            position: absolute;
            top: 1px;
            right: 1px;
            font-size: 0.55rem;
            padding: 1px 3px;
            border-radius: 2px;
            color: white;
            display: none;
        }
        
        .odd-indicator {
            background-color: #00bcd4;
        }
        
        .even-indicator {
            background-color: #4caf50;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }
        
        .action-btn {
            flex: 1;
            min-width: 60px;
            padding: 8px 6px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .import-btn {
            background-color: #ff9800;
            color: white;
        }
        
        .export-btn {
            background-color: #4caf50;
            color: white;
        }
        
        .clear-btn {
            background-color: #f44336;
            color: white;
        }
        
        .time-btn {
            background-color: #9c27b0;
            color: white;
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 380px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c5282;
        }
        
        .modal-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .save-options {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .save-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .save-option:hover {
            background-color: #f0f7ff;
        }
        
        .save-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .save-option.this-week {
            color: #ff5722;
            font-weight: 600;
        }
        
        .delete-options {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .delete-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-option:hover {
            background-color: #ffebee;
        }
        
        .delete-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .delete-option.this-lesson {
            color: #f44336;
            font-weight: 600;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }
        
        .modal-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .modal-save {
            background-color: #4caf50;
            color: white;
        }
        
        .modal-delete {
            background-color: #f44336;
            color: white;
        }
        
        .modal-cancel {
            background-color: #9e9e9e;
            color: white;
        }
        
        .time-modal-content {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .time-input-group label {
            min-width: 45px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .time-input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .data-list {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            display: none;
        }
        
        .data-list-item {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .data-list-item:hover {
            background-color: #f0f7ff;
        }
        
        .history-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
        }
        
        .input-container {
            position: relative;
            margin-bottom: 8px;
        }
        
        .color-selector {
            display: flex;
            gap: 10px;
            margin: 8px 0;
        }
        
        .color-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .color-option:hover {
            background-color: #f0f7ff;
        }
        
        .color-option.selected {
            background-color: #e8f4ff;
            border: 2px solid #3a7bd5;
        }
        
        .color-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-bottom: 4px;
        }
        
        .color-black {
            background-color: #000;
        }
        
        .color-red {
            background-color: #f44336;
        }
        
        .color-green {
            background-color: #4caf50;
        }
        
        .edit-mode-info {
            background-color: #e8f4ff;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #2c5282;
            display: none;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px 6px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 10px;
            }
            
            .date-info {
                font-size: 1rem;
                justify-content: space-between;
            }
            
            .week-nav-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
                min-width: 70px;
            }
            
            .notes-search-row {
                flex-direction: row;
            }
            
            .search-section {
                width: 36px;
            }
            
            .search-toggle {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .search-box.active {
                width: 140px;
            }
            
            .search-results {
                width: 95%;
                max-height: 50vh;
            }
            
            .timetable {
                grid-template-columns: 45px repeat(5, 1fr);
                max-height: 55vh;
            }
            
            .course-cell {
                min-height: 34px;
            }
            
            .action-btn {
                min-width: 55px;
                padding: 7px 5px;
                font-size: 0.75rem;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .timetable::-webkit-scrollbar {
            width: 4px;
        }
        
        .timetable::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .timetable::-webkit-scrollbar-thumb {
            background: #b0b0b0;
            border-radius: 2px;
        }
        
        .timetable::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="date-info">
                <span id="currentDate">2025/12/26 ç¬¬21/25å‘¨</span>
                <span class="week-type-display" id="weekTypeDisplay">å•å‘¨</span>
                <button class="calendar-btn" id="calendarBtn" title="è®¾ç½®èµ·å§‹æ—¥æœŸ">
                    <i class="fas fa-calendar-alt"></i>
                </button>
            </div>
            <div class="week-nav">
                <button class="week-nav-btn" id="prevWeek">ä¸Šä¸€å‘¨</button>
                <button class="week-nav-btn current-week" id="currentWeek">æœ¬å‘¨</button>
                <button class="week-nav-btn" id="nextWeek">ä¸‹ä¸€å‘¨</button>
            </div>
        </div>       
        <div class="timetable" id="timetable">
            <!-- æ—¶é—´è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="notes-search-row">
            <div class="notes-section">
                <div class="notes-label">
                    <span id="currentNoteDay">å‘¨ä¸€ (12/26) å½“å¤©å¤‡æ³¨</span>
                </div>
                <textarea class="notes-input" id="dailyNotes" placeholder="è¾“å…¥å½“å¤©çš„å¤‡æ³¨ä¿¡æ¯..."></textarea>
            </div>
            
            <div class="search-section">
                <div class="search-container">
                    <button class="search-toggle" id="searchToggle">ğŸ”</button>
                    <div class="search-box" id="searchBox">
                        <input type="text" class="search-input" id="searchNotes" placeholder="æœç´¢å¤‡æ³¨...">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
        
        <div class="action-bar">
            <button class="action-btn import-btn" id="importBtn">å¯¼å…¥</button>
            <button class="action-btn export-btn" id="exportBtn">å¯¼å‡º</button>
            <button class="action-btn clear-btn" id="clearBtn">æ¸…ç©º</button>
            <button class="action-btn time-btn" id="timeBtn">æ—¶é—´</button>
        </div>
    </div>
    
    <!-- è¯¾ç¨‹ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">ç¼–è¾‘è¯¾ç¨‹</div>
            
            <div class="input-container">
                <input type="text" class="modal-input" id="courseSubject" placeholder="ç§‘ç›®" list="subjectHistory">
                <button class="history-btn" id="subjectHistoryBtn">â–¼</button>
                <div class="data-list" id="subjectHistoryList"></div>
            </div>
            
            <div class="input-container">
                <input type="text" class="modal-input" id="courseClass" placeholder="ç­çº§" list="classHistory">
                <button class="history-btn" id="classHistoryBtn">â–¼</button>
                <div class="data-list" id="classHistoryList"></div>
            </div>
            
            <div class="input-container">
                <input type="text" class="modal-input" id="courseRoom" placeholder="æ•™å®¤" list="roomHistory">
                <button class="history-btn" id="roomHistoryBtn">â–¼</button>
                <div class="data-list" id="roomHistoryList"></div>
            </div>
            
            <!-- å­—ä½“é¢œè‰²é€‰æ‹©å™¨ -->
            <div class="color-selector">
                <div class="color-option" data-color="black">
                    <div class="color-dot color-black"></div>
                    <span style="font-size: 0.8rem;">é»‘è‰²</span>
                </div>
                <div class="color-option" data-color="red">
                    <div class="color-dot color-red"></div>
                    <span style="font-size: 0.8rem;">çº¢è‰²</span>
                </div>
                <div class="color-option" data-color="green">
                    <div class="color-dot color-green"></div>
                    <span style="font-size: 0.8rem;">ç»¿è‰²</span>
                </div>
            </div>
            
            <div class="save-options" id="saveOptions">
                <div class="save-option this-week">
                    <input type="radio" id="saveThisWeek" name="saveOption" value="thisWeek" checked>
                    <label for="saveThisWeek">ä»…ä¿å­˜åˆ°æœ¬å‘¨</label>
                </div>
                <div class="save-option">
                    <input type="radio" id="saveAllOdd" name="saveOption" value="allOdd">
                    <label for="saveAllOdd">ä¿å­˜åˆ°å…¨éƒ¨å•å‘¨</label>
                </div>
                <div class="save-option">
                    <input type="radio" id="saveAllEven" name="saveOption" value="allEven">
                    <label for="saveAllEven">ä¿å­˜åˆ°å…¨éƒ¨åŒå‘¨</label>
                </div>
                <div class="save-option">
                    <input type="radio" id="saveAllWeeks" name="saveOption" value="allWeeks">
                    <label for="saveAllWeeks">ä¿å­˜åˆ°å…¨éƒ¨å•åŒå‘¨</label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelCourse">å–æ¶ˆ</button>
                <button class="modal-btn modal-save" id="saveCourse">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- è¯¾ç¨‹åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">åˆ é™¤è¯¾ç¨‹</div>
            
            <div class="delete-options">
                <div class="delete-option this-lesson">
                    <input type="radio" id="deleteThisLesson" name="deleteOption" value="thisLesson" checked>
                    <label for="deleteThisLesson">åªåˆ é™¤æœ¬èŠ‚è¯¾</label>
                </div>
                <div class="delete-option">
                    <input type="radio" id="deleteAllOdd" name="deleteOption" value="allOdd">
                    <label for="deleteAllOdd">åˆ é™¤æœ¬èŠ‚å…¨éƒ¨å•å‘¨</label>
                </div>
                <div class="delete-option">
                    <input type="radio" id="deleteAllEven" name="deleteOption" value="allEven">
                    <label for="deleteAllEven">åˆ é™¤æœ¬èŠ‚å…¨éƒ¨åŒå‘¨</label>
                </div>
                <div class="delete-option">
                    <input type="radio" id="deleteAllWeeks" name="deleteOption" value="allWeeks">
                    <label for="deleteAllWeeks">åˆ é™¤æœ¬èŠ‚å…¨éƒ¨å•åŒå‘¨</label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelDelete">å–æ¶ˆ</button>
                <button class="modal-btn modal-delete" id="confirmDelete">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- æ—¶é—´è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="timeModal">
        <div class="modal-content time-modal-content">
            <div class="modal-header">è®¾ç½®è¯¾ç¨‹æ—¶é—´</div>
            <div id="timeInputs">
                <!-- æ—¶é—´è¾“å…¥æ¡†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelTime">å–æ¶ˆ</button>
                <button class="modal-btn modal-save" id="saveTime">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- èµ·å§‹æ—¥æœŸè®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="startDateModal">
        <div class="modal-content">
            <div class="modal-header">è®¾ç½®å­¦æœŸèµ·å§‹æ—¥æœŸ</div>
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">é€‰æ‹©å­¦æœŸå¼€å§‹çš„æ—¥æœŸï¼š</label>
                <input type="date" class="modal-input" id="startDateInput" value="2025-09-01">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelStartDate">å–æ¶ˆ</button>
                <button class="modal-btn modal-save" id="saveStartDate">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentWeek = 21; // å½“å‰å‘¨ï¼ˆä»21å¼€å§‹ï¼‰
        const totalWeeks = 25; // æ€»å‘¨æ•°
        let selectedCell = null; // å½“å‰é€‰ä¸­çš„è¯¾ç¨‹å•å…ƒæ ¼
        let selectedDay = 0; // å½“å‰é€‰ä¸­çš„æ˜ŸæœŸï¼ˆ0-4å¯¹åº”å‘¨ä¸€åˆ°å‘¨äº”ï¼‰
        let currentWeekType = 'odd'; // å½“å‰å‘¨ç±»å‹ï¼ˆoddå•å‘¨/evenåŒå‘¨ï¼‰
        let isCurrentWeek = true; // æ˜¯å¦å½“å‰å‘¨
        let searchResults = []; // æœç´¢ç»“æœ
        let currentDateData = {}; // å­˜å‚¨å½“å‰å‘¨çš„æ—¥æœŸæ•°æ®
        let startDate = new Date('2025-09-01'); // å­¦æœŸèµ·å§‹æ—¥æœŸ
        let isSearchActive = false; // æœç´¢æ¡†æ˜¯å¦æ¿€æ´»
        let selectedColor = 'black'; // é»˜è®¤é¢œè‰²
        let longPressTimer = null; // é•¿æŒ‰è®¡æ—¶å™¨
        let isLongPress = false; // æ˜¯å¦é•¿æŒ‰çŠ¶æ€
        
        // é»˜è®¤è¯¾ç¨‹æ—¶é—´ï¼ˆ7èŠ‚è¯¾ï¼‰
        let classTimes = [
            "08:00-08:45",
            "08:55-09:40",
            "10:00-10:45",
            "11:00-11:45",
            "14:00-14:45",
            "15:00-15:45",
            "16:00-16:45"
        ];
        
        // è¯¾ç¨‹æ•°æ® - æ–°çš„æ•°æ®ç»“æ„ï¼šæŒ‰å‘¨å­˜å‚¨ courseData[week][day][slot]
        let courseData = {};
        
        // é»˜è®¤å¤‡æ³¨æ•°æ® - æŒ‰å‘¨å’Œå¤©å­˜å‚¨
        let notesData = {};
        
        // å†å²è®°å½•æ•°æ®
        let historyData = {
            subjects: [],
            classes: [],
            rooms: []
        };
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            // è®¾ç½®å½“å‰æ—¥æœŸ
            updateCurrentDate();
            
            // ç”Ÿæˆè¯¾ç¨‹è¡¨
            generateTimetable();
            
            // åŠ è½½ä¿å­˜çš„æ•°æ®
            loadSavedData();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ˜¾ç¤ºç¼–è¾‘æç¤º
            document.getElementById('editModeInfo').style.display = 'block';
        }
        
        // æ›´æ–°å½“å‰æ—¥æœŸæ˜¾ç¤º
        function updateCurrentDate() {
            const today = new Date();
            
            // è®¡ç®—å½“å‰æ˜¯ç¬¬å‡ å‘¨
            const daysDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const weekNumber = Math.floor(daysDiff / 7) + 1;
            
            // ç¡®ä¿å‘¨æ•°åœ¨1-25ä¹‹é—´
            if (isCurrentWeek) {
                currentWeek = Math.max(1, Math.min(weekNumber, totalWeeks));
            }
            
            // ç¡®å®šå•åŒå‘¨ï¼ˆåŸºäºå½“å‰å‘¨æ•°ï¼‰
            currentWeekType = currentWeek % 2 === 1 ? 'odd' : 'even';
            document.getElementById('weekTypeDisplay').textContent = currentWeekType === 'odd' ? 'å•å‘¨' : 'åŒå‘¨';
            
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
            document.getElementById('currentDate').textContent = `${dateStr} ç¬¬${currentWeek}/${totalWeeks}å‘¨`;
            
            // æ›´æ–°å‘¨ä¸€åˆ°å‘¨äº”çš„æ—¥æœŸ
            updateWeekdayDates();
            
            // æ›´æ–°è¯¾ç¨‹è¡¨å•åŒå‘¨æ˜¾ç¤º
            updateWeekTypeDisplay();
            
            // æ›´æ–°"æœ¬å‘¨"æŒ‰é’®çŠ¶æ€
            updateCurrentWeekButton();
        }
        
        // æ›´æ–°å‘¨ç±»å‹æ˜¾ç¤º
        function updateWeekTypeDisplay() {
            document.getElementById('weekTypeDisplay').textContent = currentWeekType === 'odd' ? 'å•å‘¨' : 'åŒå‘¨';
            
            // æ›´æ–°è¯¾ç¨‹è¡¨å•åŒå‘¨æ˜¾ç¤º
            document.querySelectorAll('.course-cell').forEach(cell => {
                cell.className = cell.className.replace('odd-week', '').replace('even-week', '').trim();
                cell.classList.add(currentWeekType === 'odd' ? 'odd-week' : 'even-week');
            });
        }
        
        // æ›´æ–°"æœ¬å‘¨"æŒ‰é’®çŠ¶æ€
        function updateCurrentWeekButton() {
            const currentWeekBtn = document.getElementById('currentWeek');
            if (isCurrentWeek) {
                currentWeekBtn.textContent = 'æœ¬å‘¨';
                currentWeekBtn.classList.remove('back-to-current');
                currentWeekBtn.classList.add('current-week');
            } else {
                currentWeekBtn.textContent = 'å›åˆ°æœ¬å‘¨';
                currentWeekBtn.classList.remove('current-week');
                currentWeekBtn.classList.add('back-to-current');
            }
        }
        
        // æ›´æ–°å¤‡æ³¨æ ‡é¢˜
        function updateNotesHeader() {
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
            const dateInfo = currentDateData[selectedDay] || { month: 12, day: 26 };
            const month = dateInfo.month || 12;
            const day = dateInfo.day || 26;
            document.getElementById('currentNoteDay').textContent = `${weekdays[selectedDay]} (${month}/${day}) å½“å¤©å¤‡æ³¨`;
        }
        
        // æ›´æ–°å‘¨ä¸€åˆ°å‘¨äº”çš„æ—¥æœŸ
        function updateWeekdayDates() {
            // è®¡ç®—ç¬¬ä¸€å‘¨çš„å‘¨ä¸€
            const startDayOfWeek = startDate.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, ..., 6=å‘¨å…­
            const firstMonday = new Date(startDate);
            
            // è°ƒæ•´åˆ°ç¬¬ä¸€å‘¨çš„å‘¨ä¸€
            if (startDayOfWeek === 0) {
                firstMonday.setDate(startDate.getDate() - 6); // å¦‚æœèµ·å§‹æ—¥æ˜¯å‘¨æ—¥ï¼Œå‘¨ä¸€å°±æ˜¯å‰6å¤©
            } else {
                firstMonday.setDate(startDate.getDate() - (startDayOfWeek - 1)); // è°ƒæ•´åˆ°å‘¨ä¸€
            }
            
            // è®¡ç®—å½“å‰å‘¨çš„å‘¨ä¸€ï¼ˆæ ¹æ®å½“å‰å‘¨æ•°ï¼‰
            const currentWeekMonday = new Date(firstMonday);
            currentWeekMonday.setDate(firstMonday.getDate() + (currentWeek - 1) * 7);
            
            // æ¸…ç©ºæ—¥æœŸæ•°æ®
            currentDateData = {};
            
            // æ›´æ–°å‘¨ä¸€åˆ°å‘¨äº”çš„æ—¥æœŸæ˜¾ç¤º
            for (let i = 0; i < 5; i++) {
                const date = new Date(currentWeekMonday);
                date.setDate(currentWeekMonday.getDate() + i);
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                // å­˜å‚¨æ—¥æœŸæ•°æ®
                currentDateData[i] = { month, day, dateObj: date };
            }
            
            // æ›´æ–°å¤‡æ³¨æ ‡é¢˜
            updateNotesHeader();
            
            // åŠ è½½å½“å¤©çš„å¤‡æ³¨
            loadDailyNotes();
        }
        
        // ç”Ÿæˆè¯¾ç¨‹è¡¨
        function generateTimetable() {
            const timetableDiv = document.getElementById('timetable');
            timetableDiv.innerHTML = '';
            
            // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ªæ ¼å­ï¼ˆå·¦ä¸Šè§’ï¼‰
            const cornerCell = document.createElement('div');
            cornerCell.className = 'corner-cell';
            cornerCell.innerHTML = 'èŠ‚æ¬¡/æ˜ŸæœŸ';
            timetableDiv.appendChild(cornerCell);
            
            // ç¬¬ä¸€è¡Œçš„å‘¨ä¸€åˆ°å‘¨äº”æ ‡é¢˜ï¼ˆåŒ…å«æ—¥æœŸï¼‰
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
            for (let j = 0; j < 5; j++) {
                const weekdayCell = document.createElement('div');
                weekdayCell.className = 'corner-cell';
                
                // è·å–æ—¥æœŸä¿¡æ¯
                const dateInfo = currentDateData[j] || { month: 12, day: 26 };
                const month = dateInfo.month || 12;
                const day = dateInfo.day || 26;
                
                weekdayCell.innerHTML = `${weekdays[j]}<br><span style="font-size:0.6rem">${month}/${day}</span>`;
                weekdayCell.dataset.day = j;
                
                // ç‚¹å‡»äº‹ä»¶
                weekdayCell.addEventListener('click', () => {
                    selectedDay = j;
                    
                    // æ›´æ–°å¤‡æ³¨æ ‡é¢˜
                    updateNotesHeader();
                    
                    // åŠ è½½å½“å¤©çš„å¤‡æ³¨
                    loadDailyNotes();
                });
                
                timetableDiv.appendChild(weekdayCell);
            }
            
            // ç”Ÿæˆæ—¶é—´åˆ—å’Œè¯¾ç¨‹å•å…ƒæ ¼
            for (let i = 0; i < 7; i++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.innerHTML = `
                    <div class="time-label">ç¬¬${i+1}èŠ‚</div>
                    <div class="time-edit">${classTimes[i]}</div>
                `;
                timetableDiv.appendChild(timeSlot);
                
                // ç”Ÿæˆæ¯å¤©çš„è¯¾ç¨‹å•å…ƒæ ¼
                for (let j = 0; j < 5; j++) {
                    const courseCell = document.createElement('div');
                    courseCell.className = `course-cell ${currentWeekType === 'odd' ? 'odd-week' : 'even-week'}`;
                    courseCell.dataset.day = j;
                    courseCell.dataset.slot = i;
                    
                    // è¯¾ç¨‹å†…å®¹å®¹å™¨
                    const courseContent = document.createElement('div');
                    courseContent.className = 'course-content';
                    courseCell.appendChild(courseContent);
                    
                    // ç‚¹å‡»äº‹ä»¶ - çŸ­æŒ‰ç¼–è¾‘
                    courseCell.addEventListener('click', () => {
                        if (!isLongPress) {
                            selectedCell = courseCell;
                            const day = parseInt(selectedCell.dataset.day);
                            const slot = parseInt(selectedCell.dataset.slot);
                            openCourseEditor(day, slot);
                        }
                        isLongPress = false;
                    });
                    
                    // é•¿æŒ‰äº‹ä»¶ - é•¿æŒ‰åˆ é™¤
                    courseCell.addEventListener('mousedown', (e) => {
                        startLongPress(e, courseCell);
                    });
                    
                    courseCell.addEventListener('touchstart', (e) => {
                        startLongPress(e, courseCell);
                    });
                    
                    courseCell.addEventListener('mouseup', cancelLongPress);
                    courseCell.addEventListener('mouseleave', cancelLongPress);
                    courseCell.addEventListener('touchend', cancelLongPress);
                    courseCell.addEventListener('touchcancel', cancelLongPress);
                    
                    timetableDiv.appendChild(courseCell);
                }
            }
            
            // æ›´æ–°è¯¾ç¨‹å†…å®¹
            updateCourseDisplay();
        }
        
        // å¼€å§‹é•¿æŒ‰
        function startLongPress(e, cell) {
            isLongPress = false;
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                selectedCell = cell;
                const day = parseInt(selectedCell.dataset.day);
                const slot = parseInt(selectedCell.dataset.slot);
                openDeleteModal(day, slot);
            }, 500); // é•¿æŒ‰500æ¯«ç§’è§¦å‘
        }
        
        // å–æ¶ˆé•¿æŒ‰
        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        // æ‰“å¼€è¯¾ç¨‹ç¼–è¾‘å™¨
        function openCourseEditor(day, slot) {
            const modal = document.getElementById('courseModal');
            
            // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
            const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
            const dateInfo = currentDateData[day] || { month: 12, day: 26 };
            document.getElementById('modalHeader').textContent = `ç¼–è¾‘è¯¾ç¨‹ - ${weekdays[day]} ç¬¬${slot+1}èŠ‚`;
            
            // æ£€æŸ¥å½“å‰å‘¨æ˜¯å¦æœ‰æ•°æ®
            const currentWeekKey = `${currentWeek}_${day}_${slot}`;
            if (courseData[currentWeekKey]) {
                document.getElementById('courseSubject').value = courseData[currentWeekKey].subject || '';
                document.getElementById('courseClass').value = courseData[currentWeekKey].class || '';
                document.getElementById('courseRoom').value = courseData[currentWeekKey].room || '';
                
                // è®¾ç½®é¢œè‰²
                selectedColor = courseData[currentWeekKey].color || 'black';
                updateColorSelector(selectedColor);
            } else {
                // å¦‚æœæ²¡æœ‰å½“å‰å‘¨çš„æ•°æ®ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å•åŒå‘¨æ•°æ®
                document.getElementById('courseSubject').value = '';
                document.getElementById('courseClass').value = '';
                document.getElementById('courseRoom').value = '';
                selectedColor = 'black';
                updateColorSelector('black');
            }
            
            // è®¾ç½®é»˜è®¤ä¿å­˜é€‰é¡¹
            document.getElementById('saveThisWeek').checked = true;
            
            // åŠ è½½å†å²è®°å½•
            loadHistoryLists();
            
            modal.style.display = 'flex';
        }
        
        // æ‰“å¼€åˆ é™¤æ¨¡æ€æ¡†
        function openDeleteModal(day, slot) {
            const modal = document.getElementById('deleteModal');
            
            // è®¾ç½®é»˜è®¤åˆ é™¤é€‰é¡¹
            document.getElementById('deleteThisLesson').checked = true;
            
            modal.style.display = 'flex';
        }
        
        // æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
        function updateColorSelector(color) {
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.color === color) {
                    option.classList.add('selected');
                }
            });
        }
        
        // ä¿å­˜è¯¾ç¨‹ - ä¿®å¤BUGï¼šä»…ä¿å­˜åˆ°æœ¬å‘¨æ—¶åªä¿å­˜å½“å‰å‘¨
        function saveCourse() {
            if (!selectedCell) {
                alert('è¯·å…ˆé€‰æ‹©è¦ç¼–è¾‘çš„è¯¾ç¨‹å•å…ƒæ ¼');
                return;
            }
            
            const day = parseInt(selectedCell.dataset.day);
            const slot = parseInt(selectedCell.dataset.slot);
            const subject = document.getElementById('courseSubject').value.trim();
            const classVal = document.getElementById('courseClass').value.trim();
            const room = document.getElementById('courseRoom').value.trim();
            
            // è·å–ä¿å­˜é€‰é¡¹
            const saveOption = document.querySelector('input[name="saveOption"]:checked').value;
            
            // æ ¹æ®ä¿å­˜é€‰é¡¹å¤„ç†æ•°æ®
            if (saveOption === 'thisWeek') {
                // ä»…ä¿å­˜åˆ°æœ¬å‘¨ - åªä¿å­˜å½“å‰å‘¨
                const courseKey = `${currentWeek}_${day}_${slot}`;
                if (subject || classVal || room) {
                    courseData[courseKey] = { 
                        subject, 
                        class: classVal, 
                        room,
                        color: selectedColor,
                        saveType: 'thisWeek' // æ ‡è®°ä¿å­˜ç±»å‹
                    };
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    addToHistory('subjects', subject);
                    addToHistory('classes', classVal);
                    addToHistory('rooms', room);
                } else {
                    delete courseData[courseKey];
                }
            } else if (saveOption === 'allOdd') {
                // ä¿å­˜åˆ°å…¨éƒ¨å•å‘¨
                for (let week = 1; week <= totalWeeks; week += 2) {
                    const courseKey = `${week}_${day}_${slot}`;
                    if (subject || classVal || room) {
                        courseData[courseKey] = { 
                            subject, 
                            class: classVal, 
                            room,
                            color: selectedColor,
                            saveType: 'allOdd'
                        };
                    } else {
                        delete courseData[courseKey];
                    }
                }
                // æ·»åŠ åˆ°å†å²è®°å½•
                if (subject || classVal || room) {
                    addToHistory('subjects', subject);
                    addToHistory('classes', classVal);
                    addToHistory('rooms', room);
                }
            } else if (saveOption === 'allEven') {
                // ä¿å­˜åˆ°å…¨éƒ¨åŒå‘¨
                for (let week = 2; week <= totalWeeks; week += 2) {
                    const courseKey = `${week}_${day}_${slot}`;
                    if (subject || classVal || room) {
                        courseData[courseKey] = { 
                            subject, 
                            class: classVal, 
                            room,
                            color: selectedColor,
                            saveType: 'allEven'
                        };
                    } else {
                        delete courseData[courseKey];
                    }
                }
                // æ·»åŠ åˆ°å†å²è®°å½•
                if (subject || classVal || room) {
                    addToHistory('subjects', subject);
                    addToHistory('classes', classVal);
                    addToHistory('rooms', room);
                }
            } else if (saveOption === 'allWeeks') {
                // ä¿å­˜åˆ°å…¨éƒ¨å•åŒå‘¨
                for (let week = 1; week <= totalWeeks; week++) {
                    const courseKey = `${week}_${day}_${slot}`;
                    if (subject || classVal || room) {
                        courseData[courseKey] = { 
                            subject, 
                            class: classVal, 
                            room,
                            color: selectedColor,
                            saveType: 'allWeeks'
                        };
                    } else {
                        delete courseData[courseKey];
                    }
                }
                // æ·»åŠ åˆ°å†å²è®°å½•
                if (subject || classVal || room) {
                    addToHistory('subjects', subject);
                    addToHistory('classes', classVal);
                    addToHistory('rooms', room);
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateCourseDisplay();
            
            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
            saveData();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeCourseEditor();
        }
        
        // åˆ é™¤è¯¾ç¨‹ - ä¿®å¤BUGï¼šåªåˆ é™¤æœ¬èŠ‚è¯¾æ—¶åªåˆ é™¤å½“å‰å‘¨
        function deleteCourse() {
            if (!selectedCell) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¯¾ç¨‹å•å…ƒæ ¼');
                return;
            }
            
            const day = parseInt(selectedCell.dataset.day);
            const slot = parseInt(selectedCell.dataset.slot);
            
            // è·å–åˆ é™¤é€‰é¡¹
            const deleteOption = document.querySelector('input[name="deleteOption"]:checked').value;
            
            // æ ¹æ®åˆ é™¤é€‰é¡¹å¤„ç†æ•°æ®
            if (deleteOption === 'thisLesson') {
                // åªåˆ é™¤æœ¬èŠ‚è¯¾ - åªåˆ é™¤å½“å‰å‘¨çš„è¯¾ç¨‹
                const courseKey = `${currentWeek}_${day}_${slot}`;
                delete courseData[courseKey];
            } else if (deleteOption === 'allOdd') {
                // åˆ é™¤æœ¬èŠ‚å…¨éƒ¨å•å‘¨
                for (let week = 1; week <= totalWeeks; week += 2) {
                    const courseKey = `${week}_${day}_${slot}`;
                    delete courseData[courseKey];
                }
            } else if (deleteOption === 'allEven') {
                // åˆ é™¤æœ¬èŠ‚å…¨éƒ¨åŒå‘¨
                for (let week = 2; week <= totalWeeks; week += 2) {
                    const courseKey = `${week}_${day}_${slot}`;
                    delete courseData[courseKey];
                }
            } else if (deleteOption === 'allWeeks') {
                // åˆ é™¤æœ¬èŠ‚å…¨éƒ¨å•åŒå‘¨
                for (let week = 1; week <= totalWeeks; week++) {
                    const courseKey = `${week}_${day}_${slot}`;
                    delete courseData[courseKey];
                }
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateCourseDisplay();
            
            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
            saveData();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeDeleteModal();
        }
        
        // å…³é—­è¯¾ç¨‹ç¼–è¾‘å™¨
        function closeCourseEditor() {
            document.getElementById('courseModal').style.display = 'none';
            selectedCell = null;
        }
        
        // å…³é—­åˆ é™¤æ¨¡æ€æ¡†
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            selectedCell = null;
        }
        
        // æ›´æ–°è¯¾ç¨‹æ˜¾ç¤º
        function updateCourseDisplay() {
            const courseCells = document.querySelectorAll('.course-cell');
            
            courseCells.forEach(cell => {
                const day = parseInt(cell.dataset.day);
                const slot = parseInt(cell.dataset.slot);
                const courseKey = `${currentWeek}_${day}_${slot}`;
                
                // è·å–æˆ–åˆ›å»ºè¯¾ç¨‹å†…å®¹å®¹å™¨
                let courseContent = cell.querySelector('.course-content');
                if (!courseContent) {
                    courseContent = document.createElement('div');
                    courseContent.className = 'course-content';
                    cell.appendChild(courseContent);
                }
                
                // æ¸…ç©ºå†…å®¹
                courseContent.innerHTML = '';
                
                if (courseData[courseKey]) {
                    const course = courseData[courseKey];
                    
                    if (course.subject) {
                        const subjectDiv = document.createElement('div');
                        subjectDiv.className = 'course-subject';
                        subjectDiv.textContent = course.subject;
                        // åº”ç”¨é¢œè‰²
                        subjectDiv.classList.add(`text-${course.color || 'black'}`);
                        courseContent.appendChild(subjectDiv);
                    }
                    
                    if (course.class || course.room) {
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'course-details';
                        detailsDiv.textContent = `${course.class || ''} ${course.room || ''}`;
                        courseContent.appendChild(detailsDiv);
                    }
                }
                // æ²¡æœ‰æ•°æ®æ—¶ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ï¼Œä¿æŒç©ºç™½
                
                // ç¡®ä¿å•åŒå‘¨æ ·å¼æ­£ç¡®
                cell.className = 'course-cell';
                if (currentWeek % 2 === 1) {
                    cell.classList.add('odd-week');
                } else {
                    cell.classList.add('even-week');
                }
            });
        }
        
        // æ‰“å¼€æ—¶é—´è®¾ç½®
        function openTimeSettings() {
            const modal = document.getElementById('timeModal');
            const timeInputsDiv = document.getElementById('timeInputs');
            timeInputsDiv.innerHTML = '';
            
            // ç”Ÿæˆ7ä¸ªæ—¶é—´è¾“å…¥æ¡†
            for (let i = 0; i < 7; i++) {
                const timeInputGroup = document.createElement('div');
                timeInputGroup.className = 'time-input-group';
                timeInputGroup.innerHTML = `
                    <label>ç¬¬${i+1}èŠ‚:</label>
                    <input type="text" class="time-input" id="time-${i}" value="${classTimes[i]}" placeholder="ä¾‹å¦‚: 08:00-08:45">
                `;
                timeInputsDiv.appendChild(timeInputGroup);
            }
            
            modal.style.display = 'flex';
        }
        
        // ä¿å­˜æ—¶é—´è®¾ç½®
        function saveTimeSettings() {
            for (let i = 0; i < 7; i++) {
                const timeInput = document.getElementById(`time-${i}`);
                classTimes[i] = timeInput.value.trim();
            }
            
            // æ›´æ–°è¯¾ç¨‹è¡¨ä¸­çš„æ—¶é—´æ˜¾ç¤º
            document.querySelectorAll('.time-slot').forEach((slot, index) => {
                const timeEdit = slot.querySelector('.time-edit');
                if (timeEdit && classTimes[index]) {
                    timeEdit.textContent = classTimes[index];
                }
            });
            
            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
            saveData();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeTimeSettings();
        }
        
        // å…³é—­æ—¶é—´è®¾ç½®
        function closeTimeSettings() {
            document.getElementById('timeModal').style.display = 'none';
        }
        
        // æ‰“å¼€èµ·å§‹æ—¥æœŸè®¾ç½®
        function openStartDateModal() {
            const modal = document.getElementById('startDateModal');
            // è®¾ç½®å½“å‰æ—¥æœŸ
            document.getElementById('startDateInput').value = formatDateForInput(startDate);
            modal.style.display = 'flex';
        }
        
        // ä¿å­˜èµ·å§‹æ—¥æœŸ
        function saveStartDate() {
            const dateInput = document.getElementById('startDateInput').value;
            if (dateInput) {
                startDate = new Date(dateInput);
                updateCurrentDate();
                updateWeekDisplay();
                saveData();
            }
            closeStartDateModal();
        }
        
        // å…³é—­èµ·å§‹æ—¥æœŸè®¾ç½®
        function closeStartDateModal() {
            document.getElementById('startDateModal').style.display = 'none';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DDæ ¼å¼
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // åˆ‡æ¢æœç´¢æ¡†æ˜¾ç¤º
        function toggleSearchBox() {
            const searchBox = document.getElementById('searchBox');
            const searchInput = document.getElementById('searchNotes');
            
            if (isSearchActive) {
                searchBox.classList.remove('active');
                searchInput.blur();
                hideSearchResults();
            } else {
                searchBox.classList.add('active');
                setTimeout(() => {
                    searchInput.focus();
                }, 100);
            }
            
            isSearchActive = !isSearchActive;
        }
        
        // éšè—æœç´¢ç»“æœ
        function hideSearchResults() {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'none';
        }
        
        // åŠ è½½å½“å¤©çš„å¤‡æ³¨
        function loadDailyNotes() {
            const noteKey = `notes-${currentWeek}-${selectedDay}`;
            document.getElementById('dailyNotes').value = notesData[noteKey] || '';
        }
        
        // ä¿å­˜å½“å¤©çš„å¤‡æ³¨
        function saveDailyNotes() {
            const noteKey = `notes-${currentWeek}-${selectedDay}`;
            const notes = document.getElementById('dailyNotes').value.trim();
            
            if (notes) {
                notesData[noteKey] = notes;
            } else {
                delete notesData[noteKey];
            }
            
            saveData();
        }
        
        // æœç´¢å¤‡æ³¨
        function searchNotes() {
            const searchTerm = document.getElementById('searchNotes').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!searchTerm) {
                resultsDiv.style.display = 'none';
                resultsDiv.innerHTML = '';
                return;
            }
            
            // æŸ¥æ‰¾åŒ…å«æœç´¢å…³é”®è¯çš„å¤‡æ³¨
            searchResults = [];
            
            // æœç´¢æ‰€æœ‰å‘¨çš„å¤‡æ³¨
            for (let week = 1; week <= totalWeeks; week++) {
                for (let day = 0; day < 5; day++) {
                    const noteKey = `notes-${week}-${day}`;
                    if (notesData[noteKey] && notesData[noteKey].toLowerCase().includes(searchTerm)) {
                        // è·å–æ—¥æœŸä¿¡æ¯
                        const weekdays = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
                        
                        // è®¡ç®—å…·ä½“æ—¥æœŸ
                        const weekStart = new Date(startDate);
                        weekStart.setDate(startDate.getDate() + (week - 1) * 7);
                        
                        // æ‰¾åˆ°è¯¥å‘¨çš„å‘¨ä¸€
                        const weekMonday = new Date(weekStart);
                        weekMonday.setDate(weekStart.getDate() - (weekStart.getDay() === 0 ? 6 : weekStart.getDay() - 1));
                        
                        // è®¡ç®—å…·ä½“æ—¥æœŸ
                        const specificDate = new Date(weekMonday);
                        specificDate.setDate(weekMonday.getDate() + day);
                        
                        const month = specificDate.getMonth() + 1;
                        const dayOfMonth = specificDate.getDate();
                        
                        searchResults.push({
                            week: week,
                            day: day,
                            dayName: weekdays[day],
                            month: month,
                            dayOfMonth: dayOfMonth,
                            notes: notesData[noteKey]
                        });
                    }
                }
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            if (searchResults.length > 0) {
                resultsDiv.innerHTML = '<strong>æœç´¢ç»“æœï¼š</strong>';
                
                searchResults.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `<strong>ç¬¬${result.week}å‘¨ ${result.dayName} (${result.month}/${result.dayOfMonth})</strong><br>${result.notes.substring(0, 30)}${result.notes.length > 30 ? '...' : ''}`;
                    resultItem.dataset.week = result.week;
                    resultItem.dataset.day = result.day;
                    
                    resultItem.addEventListener('click', () => {
                        // è·³è½¬åˆ°å¯¹åº”çš„å‘¨å’Œæ—¥æœŸ
                        currentWeek = result.week;
                        selectedDay = result.day;
                        
                        // æ›´æ–°æ˜¾ç¤º
                        updateWeekDisplay();
                        
                        // éšè—æœç´¢ç»“æœ
                        resultsDiv.style.display = 'none';
                        
                        // æ¸…ç©ºæœç´¢æ¡†
                        document.getElementById('searchNotes').value = '';
                        toggleSearchBox();
                    });
                    
                    resultsDiv.appendChild(resultItem);
                });
                
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.innerHTML = '<div>æœªæ‰¾åˆ°åŒ…å«è¯¥å…³é”®è¯çš„å¤‡æ³¨ã€‚</div>';
                resultsDiv.style.display = 'block';
            }
        }
        
        // æ¸…ç©ºè¯¾ç¨‹è¡¨
        function clearTimetable() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªè¯¾ç¨‹è¡¨å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                courseData = {};
                updateCourseDisplay();
                saveData();
            }
        }
        
        // å¯¼å‡ºæ•°æ® - ç®€åŒ–çš„TXTæ ¼å¼
        function exportData() {
            // åˆ›å»ºç®€åŒ–çš„æ•°æ®ç»“æ„
            const exportData = {
                classTimes: classTimes,
                courses: {}
            };
            
            // åªå¯¼å‡ºè¯¾ç¨‹ä¿¡æ¯ï¼Œä¸å¯¼å‡ºå¤‡æ³¨
            for (const key in courseData) {
                if (courseData.hasOwnProperty(key)) {
                    exportData.courses[key] = courseData[key];
                }
            }
            
            // è½¬æ¢ä¸ºTXTæ ¼å¼
            let txtContent = "æ•™å¸ˆè¯¾ç¨‹è¡¨æ•°æ®\n";
            txtContent += "================\n\n";
            txtContent += "è¯¾ç¨‹æ—¶é—´å®‰æ’:\n";
            classTimes.forEach((time, index) => {
                txtContent += `ç¬¬${index+1}èŠ‚: ${time}\n`;
            });
            
            txtContent += "\nè¯¾ç¨‹å®‰æ’:\n";
            // æŒ‰æ˜ŸæœŸå’ŒèŠ‚æ¬¡æ’åº
            const days = ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”'];
            for (let day = 0; day < 5; day++) {
                for (let slot = 0; slot < 7; slot++) {
                    let hasOddWeek = false;
                    let hasEvenWeek = false;
                    let oddWeekData = null;
                    let evenWeekData = null;
                    
                    // æ£€æŸ¥å•å‘¨å’ŒåŒå‘¨
                    for (let week = 1; week <= totalWeeks; week++) {
                        const courseKey = `${week}_${day}_${slot}`;
                        if (courseData[courseKey]) {
                            if (week % 2 === 1) {
                                hasOddWeek = true;
                                oddWeekData = courseData[courseKey];
                            } else {
                                hasEvenWeek = true;
                                evenWeekData = courseData[courseKey];
                            }
                        }
                    }
                    
                    if (hasOddWeek || hasEvenWeek) {
                        txtContent += `${days[day]} ç¬¬${slot+1}èŠ‚:\n`;
                        
                        if (hasOddWeek && oddWeekData) {
                            txtContent += `  å•å‘¨: ${oddWeekData.subject || ''} | ${oddWeekData.class || ''} | ${oddWeekData.room || ''}\n`;
                        }
                        
                        if (hasEvenWeek && evenWeekData) {
                            txtContent += `  åŒå‘¨: ${evenWeekData.subject || ''} | ${evenWeekData.class || ''} | ${evenWeekData.room || ''}\n`;
                        }
                    }
                }
            }
            
            const blob = new Blob([txtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¯¾ç¨‹è¡¨_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å¯¼å…¥æ•°æ® - ä¿®å¤çš„è§£æé€»è¾‘
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const content = event.target.result;
                        
                        // è§£æTXTæ–‡ä»¶
                        const lines = content.split('\n');
                        let parsingTimes = false;
                        let parsingCourses = false;
                        let currentDay = -1;
                        let currentSlot = -1;
                        
                        // ä¸´æ—¶å­˜å‚¨å¯¼å…¥çš„æ•°æ®
                        const importedCourseData = {};
                        const importedClassTimes = [...classTimes]; // å¤åˆ¶é»˜è®¤æ—¶é—´
                        
                        // æ˜ŸæœŸæ˜ å°„
                        const dayMap = {
                            'å‘¨ä¸€': 0,
                            'å‘¨äºŒ': 1,
                            'å‘¨ä¸‰': 2,
                            'å‘¨å››': 3,
                            'å‘¨äº”': 4
                        };
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            
                            if (line === "è¯¾ç¨‹æ—¶é—´å®‰æ’:" || line === "è¯¾ç¨‹æ—¶é—´å®‰æ’") {
                                parsingTimes = true;
                                parsingCourses = false;
                                continue;
                            } else if (line === "è¯¾ç¨‹å®‰æ’:" || line === "è¯¾ç¨‹å®‰æ’") {
                                parsingTimes = false;
                                parsingCourses = true;
                                continue;
                            } else if (line.startsWith("æ•™å¸ˆè¯¾ç¨‹è¡¨æ•°æ®") || line.startsWith("===") || line === "") {
                                continue;
                            }
                            
                            if (parsingTimes && line.startsWith("ç¬¬")) {
                                // è§£ææ—¶é—´
                                const match = line.match(/ç¬¬\s*(\d+)\s*[èŠ‚:]?\s*(.+)/);
                                if (match) {
                                    const slot = parseInt(match[1]) - 1;
                                    const time = match[2].trim();
                                    if (slot >= 0 && slot < 7) {
                                        importedClassTimes[slot] = time;
                                    }
                                }
                            } else if (parsingCourses) {
                                // è§£æè¯¾ç¨‹
                                const dayMatch = line.match(/(å‘¨ä¸€|å‘¨äºŒ|å‘¨ä¸‰|å‘¨å››|å‘¨äº”)\s*ç¬¬\s*(\d+)\s*[èŠ‚:]/);
                                if (dayMatch) {
                                    currentDay = dayMap[dayMatch[1]];
                                    currentSlot = parseInt(dayMatch[2]) - 1;
                                    continue;
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯å•å‘¨æˆ–åŒå‘¨è¯¾ç¨‹è¡Œ
                                if (line.includes("å•å‘¨:") || line.includes("åŒå‘¨:")) {
                                    const isOdd = line.includes("å•å‘¨:");
                                    const prefix = isOdd ? "å•å‘¨:" : "åŒå‘¨:";
                                    const courseInfoStr = line.substring(line.indexOf(prefix) + prefix.length).trim();
                                    
                                    if (currentDay !== -1 && currentSlot !== -1 && courseInfoStr) {
                                        const courseInfo = courseInfoStr.split('|').map(s => s.trim());
                                        
                                        if (isOdd) {
                                            // ä¿å­˜åˆ°æ‰€æœ‰å•å‘¨
                                            for (let week = 1; week <= totalWeeks; week += 2) {
                                                const courseKey = `${week}_${currentDay}_${currentSlot}`;
                                                importedCourseData[courseKey] = {
                                                    subject: courseInfo[0] || '',
                                                    class: courseInfo[1] || '',
                                                    room: courseInfo[2] || '',
                                                    color: 'black',
                                                    saveType: 'allOdd'
                                                };
                                            }
                                        } else {
                                            // ä¿å­˜åˆ°æ‰€æœ‰åŒå‘¨
                                            for (let week = 2; week <= totalWeeks; week += 2) {
                                                const courseKey = `${week}_${currentDay}_${currentSlot}`;
                                                importedCourseData[courseKey] = {
                                                    subject: courseInfo[0] || '',
                                                    class: courseInfo[1] || '',
                                                    room: courseInfo[2] || '',
                                                    color: 'black',
                                                    saveType: 'allEven'
                                                };
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        // å°†å¯¼å…¥çš„æ•°æ®åˆå¹¶åˆ°ç°æœ‰æ•°æ®ä¸­
                        Object.assign(courseData, importedCourseData);
                        classTimes = importedClassTimes;
                        
                        // æ›´æ–°ç•Œé¢
                        updateCourseDisplay();
                        
                        // æ›´æ–°è¯¾ç¨‹è¡¨ä¸­çš„æ—¶é—´æ˜¾ç¤º
                        document.querySelectorAll('.time-slot').forEach((slot, index) => {
                            const timeEdit = slot.querySelector('.time-edit');
                            if (timeEdit && classTimes[index]) {
                                timeEdit.textContent = classTimes[index];
                            }
                        });
                        
                        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
                        saveData();
                        
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚');
                    }
                };
                
                reader.onerror = function(event) {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', event.target.error);
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                };
                
                reader.readAsText(file, 'UTF-8');
            };
            
            input.click();
        }
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
        function saveData() {
            // å‡†å¤‡æ•°æ®
            const data = {
                courseData,
                notesData,
                classTimes,
                historyData,
                currentWeek,
                currentWeekType,
                startDate: startDate.toISOString().split('T')[0]
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('teacherTimetable', JSON.stringify(data));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        function loadSavedData() {
            const savedData = localStorage.getItem('teacherTimetable');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    if (data.courseData) courseData = data.courseData;
                    if (data.notesData) notesData = data.notesData;
                    if (data.classTimes) classTimes = data.classTimes;
                    if (data.historyData) historyData = data.historyData;
                    if (data.currentWeek) currentWeek = data.currentWeek;
                    if (data.currentWeekType) currentWeekType = data.currentWeekType;
                    if (data.startDate) startDate = new Date(data.startDate);
                    
                    // æ›´æ–°ç•Œé¢
                    updateCourseDisplay();
                    loadDailyNotes();
                    updateWeekTypeDisplay();
                } catch (error) {
                    console.error('åŠ è½½æœ¬åœ°æ•°æ®æ—¶å‡ºé”™:', error);
                }
            }
        }
        
        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(type, value) {
            if (!value) return;
            
            // å¦‚æœå€¼ä¸åœ¨å†å²è®°å½•ä¸­ï¼Œæ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
            if (!historyData[type].includes(value)) {
                historyData[type].unshift(value);
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (historyData[type].length > 10) {
                    historyData[type] = historyData[type].slice(0, 10);
                }
                
                // ä¿å­˜æ•°æ®
                saveData();
            }
        }
        
        // åŠ è½½å†å²è®°å½•åˆ—è¡¨
        function loadHistoryLists() {
            // ç§‘ç›®å†å²
            const subjectList = document.getElementById('subjectHistoryList');
            subjectList.innerHTML = '';
            historyData.subjects.forEach(subject => {
                if (subject) {
                    const item = document.createElement('div');
                    item.className = 'data-list-item';
                    item.textContent = subject;
                    item.addEventListener('click', () => {
                        document.getElementById('courseSubject').value = subject;
                        subjectList.style.display = 'none';
                    });
                    subjectList.appendChild(item);
                }
            });
            
            // ç­çº§å†å²
            const classList = document.getElementById('classHistoryList');
            classList.innerHTML = '';
            historyData.classes.forEach(className => {
                if (className) {
                    const item = document.createElement('div');
                    item.className = 'data-list-item';
                    item.textContent = className;
                    item.addEventListener('click', () => {
                        document.getElementById('courseClass').value = className;
                        classList.style.display = 'none';
                    });
                    classList.appendChild(item);
                }
            });
            
            // æ•™å®¤å†å²
            const roomList = document.getElementById('roomHistoryList');
            roomList.innerHTML = '';
            historyData.rooms.forEach(room => {
                if (room) {
                    const item = document.createElement('div');
                    item.className = 'data-list-item';
                    item.textContent = room;
                    item.addEventListener('click', () => {
                        document.getElementById('courseRoom').value = room;
                        roomList.style.display = 'none';
                    });
                    roomList.appendChild(item);
                }
            });
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å¯¼å…¥æŒ‰é’®
            document.getElementById('importBtn').addEventListener('click', importData);
            
            // å¯¼å‡ºæŒ‰é’®
            document.getElementById('exportBtn').addEventListener('click', exportData);
            
            // æ¸…ç©ºæŒ‰é’®
            document.getElementById('clearBtn').addEventListener('click', clearTimetable);
            
            // æ—¶é—´æŒ‰é’®
            document.getElementById('timeBtn').addEventListener('click', openTimeSettings);
            
            // æ—¥å†æŒ‰é’®
            document.getElementById('calendarBtn').addEventListener('click', openStartDateModal);
            
            // æœç´¢åˆ‡æ¢æŒ‰é’®
            document.getElementById('searchToggle').addEventListener('click', toggleSearchBox);
            
            // æœç´¢è¾“å…¥æ¡†å›è½¦é”®
            document.getElementById('searchNotes').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchNotes();
                }
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æœç´¢æ¡†
            document.addEventListener('click', function(e) {
                const searchContainer = document.querySelector('.search-container');
                const searchBox = document.getElementById('searchBox');
                const searchToggle = document.getElementById('searchToggle');
                
                if (isSearchActive && !searchContainer.contains(e.target) && e.target !== searchToggle) {
                    toggleSearchBox();
                }
            });
            
            // å‘¨å¯¼èˆªæŒ‰é’®
            document.getElementById('prevWeek').addEventListener('click', () => {
                if (currentWeek > 1) {
                    currentWeek--;
                    isCurrentWeek = false;
                    // æ ¹æ®å‘¨æ•°ç¡®å®šå•åŒå‘¨
                    currentWeekType = currentWeek % 2 === 1 ? 'odd' : 'even';
                    updateWeekDisplay();
                }
            });
            
            document.getElementById('currentWeek').addEventListener('click', () => {
                isCurrentWeek = true;
                updateCurrentDate();
                updateWeekDisplay();
            });
            
            document.getElementById('nextWeek').addEventListener('click', () => {
                if (currentWeek < totalWeeks) {
                    currentWeek++;
                    isCurrentWeek = false;
                    // æ ¹æ®å‘¨æ•°ç¡®å®šå•åŒå‘¨
                    currentWeekType = currentWeek % 2 === 1 ? 'odd' : 'even';
                    updateWeekDisplay();
                }
            });
            
            // å¤‡æ³¨è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
            document.getElementById('dailyNotes').addEventListener('blur', saveDailyNotes);
            
            // è¯¾ç¨‹ç¼–è¾‘æ¨¡æ€æ¡† - ä¿å­˜æŒ‰é’®
            document.getElementById('saveCourse').addEventListener('click', function(e) {
                e.preventDefault();
                saveCourse();
            });
            
            // è¯¾ç¨‹ç¼–è¾‘æ¨¡æ€æ¡† - å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelCourse').addEventListener('click', closeCourseEditor);
            
            // è¯¾ç¨‹åˆ é™¤æ¨¡æ€æ¡† - åˆ é™¤æŒ‰é’®
            document.getElementById('confirmDelete').addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯¾ç¨‹å—ï¼Ÿ')) {
                    deleteCourse();
                }
            });
            
            // è¯¾ç¨‹åˆ é™¤æ¨¡æ€æ¡† - å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);
            
            // æ—¶é—´è®¾ç½®æ¨¡æ€æ¡†
            document.getElementById('saveTime').addEventListener('click', saveTimeSettings);
            document.getElementById('cancelTime').addEventListener('click', closeTimeSettings);
            
            // èµ·å§‹æ—¥æœŸè®¾ç½®æ¨¡æ€æ¡†
            document.getElementById('saveStartDate').addEventListener('click', saveStartDate);
            document.getElementById('cancelStartDate').addEventListener('click', closeStartDateModal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                const courseModal = document.getElementById('courseModal');
                const deleteModal = document.getElementById('deleteModal');
                const timeModal = document.getElementById('timeModal');
                const startDateModal = document.getElementById('startDateModal');
                
                if (event.target === courseModal) {
                    closeCourseEditor();
                }
                
                if (event.target === deleteModal) {
                    closeDeleteModal();
                }
                
                if (event.target === timeModal) {
                    closeTimeSettings();
                }
                
                if (event.target === startDateModal) {
                    closeStartDateModal();
                }
            });
            
            // å†å²è®°å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('subjectHistoryBtn').addEventListener('click', function() {
                const list = document.getElementById('subjectHistoryList');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            });
            
            document.getElementById('classHistoryBtn').addEventListener('click', function() {
                const list = document.getElementById('classHistoryList');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            });
            
            document.getElementById('roomHistoryBtn').addEventListener('click', function() {
                const list = document.getElementById('roomHistoryList');
                list.style.display = list.style.display === 'block' ? 'none' : 'block';
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å†å²è®°å½•åˆ—è¡¨
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.input-container')) {
                    document.querySelectorAll('.data-list').forEach(list => {
                        list.style.display = 'none';
                    });
                }
            });
            
            // é¢œè‰²é€‰æ‹©å™¨ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectedColor = this.dataset.color;
                    updateColorSelector(selectedColor);
                });
            });
        }
        
        // æ›´æ–°å‘¨æ˜¾ç¤º
        function updateWeekDisplay() {
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');
            document.getElementById('currentDate').textContent = `${dateStr} ç¬¬${currentWeek}/${totalWeeks}å‘¨`;
            
            // æ›´æ–°å•åŒå‘¨æ˜¾ç¤º
            updateWeekTypeDisplay();
            
            // æ›´æ–°å‘¨ä¸€åˆ°å‘¨äº”çš„æ—¥æœŸ
            updateWeekdayDates();
            
            // é‡æ–°ç”Ÿæˆè¯¾ç¨‹è¡¨ä»¥æ›´æ–°æ—¥æœŸ
            generateTimetable();
            
            // æ›´æ–°"æœ¬å‘¨"æŒ‰é’®çŠ¶æ€
            updateCurrentWeekButton();
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>